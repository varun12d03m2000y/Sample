CREATE OR REPLACE PROCEDURE `vz-it-pr-jffv-inopdo-0.vzw_inopdo_fwa_prd_tbls.check_format_issues`()
BEGIN
  DECLARE table_names ARRAY<STRUCT<
      table_name STRING,
      date_column STRING,
      mdn_column STRING,
      imei_column STRING,
      imsi_column STRING>>;
  
  SET table_names = [
    STRUCT('vz-it-pr-137v-ndlpr-0.vzn_ndl_fwa_ssot_core_tbls.fwa_mdn_health_check_dly_raw_v1', 'trans_dt', 'mdn', 'imei', 'imsi'),
    STRUCT('vz-it-pr-gk1v-cwlspr-0.vzw_uda_prd_tbls.fixed_fwa_subscriber_fact', 'insert_dt', 'mdn', 'imei', 'imsi'),
    STRUCT('vz-it-pr-fjpv-mlopdo-0.mlops_scores_tbls_v.fwa_qes_scores', 'rpt_dt', NULL, 'imei', NULL),
    STRUCT('vz-it-pr-gudv-dtwndo-0.aid_dtwin_fwa_core_tbls.fwa_active_customer_performance_daily_norm', 'trans_dt', 'mdn', NULL, NULL),
    STRUCT('vz-it-pr-gk1v-cwlspr-0.vzw_uda_prd_tbls.fixed_5g_dvc_detail', 'insert_dt', NULL, 'imei', 'imsi'),
    STRUCT('vz-it-pr-fjpv-mlopdo-0.mlops_scores_tbls_v.ntwk_nqes_score_model_scores_32', 'rpt_dt', NULL, NULL, NULL)
  ];
  
  -- Loop through each table
  FOR i IN (SELECT * FROM UNNEST(table_names)) DO
    -- Validate MDN column if present
    IF i.mdn_column IS NOT NULL THEN
      EXECUTE IMMEDIATE FORMAT("""
        INSERT INTO `vz-it-pr-jffv-inopdo-0.vzw_inopdo_fwa_prd_tbls.format_issues_summary`
        (table_name, column_name, issue_type, issue_count, issue_timestamp)
        SELECT '%s', '%s', 'Invalid Length', COUNT(*), CURRENT_TIMESTAMP()
        FROM `%s`
        WHERE LENGTH(%s) NOT IN (10, 11, 12)
        AND %s = CURRENT_DATE() - 2
        GROUP BY 1, 2, 3
      """, i.table_name, i.mdn_column, i.table_name, i.mdn_column, i.date_column);
    END IF;

    -- Validate IMEI column if present
    IF i.imei_column IS NOT NULL THEN
      EXECUTE IMMEDIATE FORMAT("""
        INSERT INTO `vz-it-pr-jffv-inopdo-0.vzw_inopdo_fwa_prd_tbls.format_issues_summary`
        (table_name, column_name, issue_type, issue_count, issue_timestamp)
        SELECT '%s', '%s', 'Empty Value', COUNT(*), CURRENT_TIMESTAMP()
        FROM `%s`
        WHERE TRIM(%s) = ''
        AND %s = CURRENT_DATE() - 2
        GROUP BY 1, 2, 3
      """, i.table_name, i.imei_column, i.table_name, i.imei_column, i.date_column);
    END IF;

    -- Validate IMSI column if present
    IF i.imsi_column IS NOT NULL THEN
      EXECUTE IMMEDIATE FORMAT("""
        INSERT INTO `vz-it-pr-jffv-inopdo-0.vzw_inopdo_fwa_prd_tbls.format_issues_summary`
        (table_name, column_name, issue_type, issue_count, issue_timestamp)
        SELECT '%s', '%s', 'Contains Hyphen', COUNT(*), CURRENT_TIMESTAMP()
        FROM `%s`
        WHERE %s LIKE '%%-%%'
        AND %s = CURRENT_DATE() - 2
        GROUP BY 1, 2, 3
      """, i.table_name, i.imsi_column, i.table_name, i.imsi_column, i.date_column);
    END IF;
  END FOR;
  
  EXECUTE IMMEDIATE "SELECT 'Procedure Completed' AS status";
END;
